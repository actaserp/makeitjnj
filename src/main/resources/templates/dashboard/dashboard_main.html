<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<style>
    #chartModal .modal-content {
        width: 80vw;
        height: 80vh;
        max-width: 800px; /
        max-height: 600px;
    }
    #modalChartHolder {
        width: 100%;
        height: 100%;
    }

</style>
<th:block layout:fragment="content">

    <!--- (레이아웃) Contents 영역 -->
    <div class="layout-contents">
        <!-- Page Title -->
        <div class="page-title-wrap" style="margin-bottom:0">
            <div class="left">
                <h2>관리자 Dashboard</h2><a id="toggleButton" onclick="toggleSearchWrap()"><img
                    src="/images/icon/ico-down.png"
                    alt="알람 아이콘"></a>
                <!--                <a title="북마크" class="bookmark toggle">-->
                <!--                    내 메뉴-->
                <!--                </a>-->
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
            </ul>
        </div>
        <!-- Select -->
        <div class="search-wrap" id="searchWrap" style="display: none; padding-top:10px">
            <ul>
                <li>
                    <select title="사업장" id="search_sjangcd" name="search_sjangcd"
                            onchange="init()">
                        <option value="" hidden selected disabled>선택</option>
                        <option value="ZZ">성우에스피(주)</option>
                        <option value="PP">성우피앤비(주)</option>
                        <!-- 지역 옵션을 JavaScript에서 동적으로 채움 -->
                    </select>
                </li>
            </ul>
        </div>
        <div class="row row-1" style="margin-bottom: 0;">
            <div class="card-wrap swiper card-swiper">
                <div class="swiper-wrapper">
                    <div class="swiper-slide">
                        <section>
                            <div class="title">
                                <h3>주문의뢰</h3>
                                <a href="#" title="더보기" class="btn-plus"></a>
                            </div>
                            <dl>
                                <dt>전년대비 건수</dt>
                                <dd>
                                    <span class="up"></span> 10 <span class="unit">건</span>
                                </dd>
                            </dl>
<!--                            <dl>-->
<!--                                <dt>전일대비</dt>-->
<!--                                <dd>-->
<!--                                    <span class="down"></span> 1.20 <span class="unit">%</span>-->
<!--                                </dd>-->
<!--                            </dl>-->
                        </section>
                    </div>
                    <div class="swiper-slide">
                        <section>
                            <div class="title">
                                <h3>견적작성</h3>
                                <a href="#" title="더보기" class="btn-plus"></a>
                            </div>
                            <dl>
                                <dt>전년대비 건수</dt>
                                <dd>
                                    <span class="up"></span> 10 <span class="unit">건</span>
                                </dd>
                            </dl>
<!--                            <dl>-->
<!--                                <dt>전일대비</dt>-->
<!--                                <dd>-->
<!--                                    <span class="up"></span> 2.20 <span class="unit">%</span>-->
<!--                                </dd>-->
<!--                            </dl>-->
                        </section>
                    </div>
                    <div class="swiper-slide">
                        <section>
                            <div class="title">
                                <h3>제작</h3>
                                <a href="#" title="더보기" class="btn-plus"></a>
                            </div>
                            <dl>
                                <dt>전년대비 건수</dt>
                                <dd>
                                    <span class="up"></span> 10 <span class="unit">건</span>
                                </dd>
                            </dl>
<!--                            <dl>-->
<!--                                <dt>전일대비</dt>-->
<!--                                <dd>-->
<!--                                    <span class="down"></span> 1.20 <span class="unit">%</span>-->
<!--                                </dd>-->
<!--                            </dl>-->
                        </section>
                    </div>
                    <div class="swiper-slide">
                        <section>
                            <div class="title">
                                <h3>출고</h3>
                                <a href="#" title="더보기" class="btn-plus"></a>
                            </div>
                            <dl>
                                <dt>전년대비 건수</dt>
                                <dd>
                                    <span class="up"></span> 10 <span class="unit">건</span>
                                </dd>
                            </dl>
<!--                            <dl>-->
<!--                                <dt>열효율</dt>-->
<!--                                <dd>-->
<!--                                    39.0 <span class="unit">%</span>-->
<!--                                </dd>-->
<!--                            </dl>-->
                        </section>
                    </div>
                    <div class="swiper-slide">
                        <section>
                            <dl>
                                <dt>예상수익</dt>
                                <dd>
                                    999,999 <span class="unit">원</span>
                                </dd>
                            </dl>
                            <dl>
                                <dt>전일대비</dt>
                                <dd>
                                    <span class="up"></span> 1.20 <span class="unit">%</span>
                                </dd>
                            </dl>
                        </section>
                    </div>
                    <div class="swiper-slide">
                        <section>
                            <div class="title">
                                <h3>주문의뢰</h3>
                                <a href="#" title="더보기" class="btn-plus"></a>
                            </div>
                            <dl>
                                <dt>전년대비 건수</dt>
                                <dd>
                                    <span class="up"></span> 10 <span class="unit">건</span>
                                </dd>
                            </dl>
                            <!--                            <dl>-->
                            <!--                                <dt>전일대비</dt>-->
                            <!--                                <dd>-->
                            <!--                                    <span class="down"></span> 1.20 <span class="unit">%</span>-->
                            <!--                                </dd>-->
                            <!--                            </dl>-->
                        </section>
                    </div>
                    <div class="swiper-slide">
                        <section>
                            <div class="title">
                                <h3>견적작성</h3>
                                <a href="#" title="더보기" class="btn-plus"></a>
                            </div>
                            <dl>
                                <dt>전년대비 건수</dt>
                                <dd>
                                    <span class="up"></span> 10 <span class="unit">건</span>
                                </dd>
                            </dl>
                            <!--                            <dl>-->
                            <!--                                <dt>전일대비</dt>-->
                            <!--                                <dd>-->
                            <!--                                    <span class="up"></span> 2.20 <span class="unit">%</span>-->
                            <!--                                </dd>-->
                            <!--                            </dl>-->
                        </section>
                    </div>
                    <div class="swiper-slide">
                        <section>
                            <div class="title">
                                <h3>제작</h3>
                                <a href="#" title="더보기" class="btn-plus"></a>
                            </div>
                            <dl>
                                <dt>전년대비 건수</dt>
                                <dd>
                                    <span class="up"></span> 10 <span class="unit">건</span>
                                </dd>
                            </dl>
                            <!--                            <dl>-->
                            <!--                                <dt>전일대비</dt>-->
                            <!--                                <dd>-->
                            <!--                                    <span class="down"></span> 1.20 <span class="unit">%</span>-->
                            <!--                                </dd>-->
                            <!--                            </dl>-->
                        </section>
                    </div>
                    <div class="swiper-slide">
                        <section>
                            <div class="title">
                                <h3>출고</h3>
                                <a href="#" title="더보기" class="btn-plus"></a>
                            </div>
                            <dl>
                                <dt>전년대비 건수</dt>
                                <dd>
                                    <span class="up"></span> 10 <span class="unit">건</span>
                                </dd>
                            </dl>
                            <!--                            <dl>-->
                            <!--                                <dt>열효율</dt>-->
                            <!--                                <dd>-->
                            <!--                                    39.0 <span class="unit">%</span>-->
                            <!--                                </dd>-->
                            <!--                            </dl>-->
                        </section>
                    </div>
                    <div class="swiper-slide">
                        <section>
                            <dl>
                                <dt>예상수익</dt>
                                <dd>
                                    999,999 <span class="unit">원</span>
                                </dd>
                            </dl>
                            <dl>
                                <dt>전일대비</dt>
                                <dd>
                                    <span class="up"></span> 1.20 <span class="unit">%</span>
                                </dd>
                            </dl>
                        </section>
                    </div>
                </div> <!--//swiper-wrapper end -->
            </div> <!--//main-card-wrap end -->
        </div>

      <div class="col wp100">
        <section style="padding-top: 5px; padding-bottom: 5px; margin-bottom: 0;">
          <div class="title-wrap">
            <ul class="tab-links-sub">
              <li>
                <a href="#tab1" title="매출액"></a>
              </li>
              <li>
                <a href="#tab2" title="수주액"></a>
              </li>
              <li>
                <a href="#tab3" title="견적진행"></a>
              </li>
              <li>
                <a href="#tab4" title="견적요청"></a>
              </li>
            </ul>
          </div>

          <div class="tab-contents">
            <div class="tab-row" style="display: flex; width: 100%; gap: 20px; margin-bottom: 3px;">
              <section style="width: 50%; height: 260px; padding: 10px;">
                <div class="tab-item-sub" id="tab1">
                  <h5>주문의뢰 건수</h5>
                  <!--<div class="chart-wrap">
                   &lt;!&ndash; <div id="chartHolder1"  style="width: 100%; height: 420px; padding-top: 13px"></div>&ndash;&gt;
                      <canvas id="revenueChart"></canvas>
                  </div>-->
                    <div class="chart-wrap" style="justify-content: normal;">
                        <canvas id="revenueChart" style="height: 200px"></canvas>
                        <span class="material-symbols-outlined" style="position: absolute; top: 17px; right: 3px; cursor: pointer; z-index: 10; color: rgb(179, 179, 179);" onclick="openModal('revenueChart')">zoom_out_map</span>
                    </div>
                </div>
              </section>
              <section style="width: 50%; height: 260px; padding: 10px;">
                <div class="tab-item-sub" id="tab2" style="height:210px;">
                  <h5>전년대비 건수</h5>
                 <!-- <div class="chart-wrap">
                    &lt;!&ndash;<div id="chartHolder2"  style="width: 100%; height: 420px; padding-top: 13px"></div>&ndash;&gt;
                      <canvas id="orderChart"></canvas>
                  </div>-->
                    <div class="chart-wrap" style="justify-content: normal; margin-bottom: 20px">
                        <canvas id="orderChart" style="height: 200px"></canvas>
                        <span class="material-symbols-outlined" style="position: absolute; top: 17px; right: 3px; cursor: pointer; z-index: 10; color: rgb(179, 179, 179);" onclick="openModal('orderChart')">zoom_out_map</span>
                    </div>
                </div>
              </section>
            </div>
            <div class="tab-row" style="display: flex; width: 100%; gap: 20px; margin-bottom: 3px;">
              <section style="width: 50%; height: 260px; padding: 10px;">
                <div class="tab-item-sub" id="tab3">
                  <h5>당월 건수</h5>
                  <!--<div class="chart-wrap">
                    &lt;!&ndash;<div id="chartHolder3"  style="width: 100%; height: 420px; padding-top: 13px"></div>&ndash;&gt;
                      <canvas id="estimateChart"></canvas>
                  </div>-->
                    <div class="chart-wrap" style="justify-content: normal; margin-bottom: 20px">
                        <canvas id="estimateChart" style="height: 200px"></canvas>
                        <span class="material-symbols-outlined" style="position: absolute; top: 17px; right: 3px; cursor: pointer; z-index: 10; color: rgb(179, 179, 179);" onclick="openModal('estimateChart')">zoom_out_map</span>
                    </div>
                </div>
              </section>
              <section style="width: 50%; height: 260px; padding: 10px;">
                <div class="tab-item-sub" id="tab4">
                  <h5>전월 건수</h5>
                  <!--<div class="chart-wrap">
                    &lt;!&ndash;<div id="chartHolder4"  style="width: 100%; height: 420px; padding-top: 13px"></div>&ndash;&gt;
                      <canvas id="requestChart"></canvas>
                  </div>-->
                    <div class="chart-wrap" style="justify-content: normal; margin-bottom: 20px">
                        <canvas id="requestChart" style="height: 200px"></canvas>
                        <span class="material-symbols-outlined" style="position: absolute; top: 17px; right: 3px; cursor: pointer; z-index: 10; color: rgb(179, 179, 179);" onclick="openModal('requestChart')">zoom_out_map</span>
                    </div>
                </div>
              </section>
            </div>
          </div>
        </section>
      </div>
    </div> <!--//layout-contents end -->
    <footer>
        <p>Copyrightⓒ 0000 corp. All rights reserved.</p>
    </footer>
    </div>

    <div style="height: 10px"></div>

    <div id="chartModal" class="modal" style="opacity:100">
        <div class="modal-content">
            <span class="close">&times;</span>
            <canvas id="modalChartHolder" style="width: 1292px; height: 474px; box-sizing: border-box; display: block;" width="1292" height="474"></canvas>
        </div>
    </div>



</th:block>
<th:block layout:fragment="scripts">
    <th:block th:replace="/common/approve_box :: approve_box"></th:block>
    <th:block th:replace="/common/ax5_uploader :: ax5_uploader"></th:block>
    <th:block th:replace="/common/upload_one_image_box :: upload_one_image_box"></th:block>
    <th:block th:replace="/common/popup_select_user_code :: popup_select_user_code"></th:block>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript">
        // 차트 데이터 설정
        const revenueData = {
            labels: ["1월", "2월", "3월", "4월", "5월", "6월", "7월", "8월", "9월", "10월", "11월", "12월"],
            datasets: [{
                label: '주문의뢰 건수',
                data: [12, 15, 18, 21, 24, 27, 15, 16, 16, 19, 22, 25],
                backgroundColor: 'rgba(98, 178, 253, 0.5)',
                borderColor: 'rgba(98, 178, 253, 1)',
                borderWidth: 1
            }]
        };

        const orderData = {
            labels: ["1월", "2월", "3월", "4월", "5월", "6월", "7월", "8월", "9월", "10월", "11월", "12월"],
            datasets: [{
                label: '전년의뢰 건수',
                data: [1000, 1200, 1500, 1800, 2000, 2200, 2400, 2600, 2800, 3000, 3200, 3500],
                backgroundColor: 'rgba(98, 178, 253, 0.5)',
                borderColor: 'rgba(98, 178, 253, 1)',
                borderWidth: 1
            }]
        };

        const estimateData = {
            labels: ["1일", "2일", "3일", "4일", "5일", "6일", "7일", "8일", "9일", "10일"
                , "11일", "12일", "13일", "14일", "15일", "16일", "17일", "18일", "19일", "20일"
                , "21일", "22일", "23일", "24일", "25일", "26일", "27일", "28일", "29일", "30일"],
            datasets: [{
                label: '당월 건수',
                data: [700, 800, 1000, 1200, 1400, 1600, 1800, 2000, 2200, 2400
                    , 2600, 2800, 700, 800, 1000, 1200, 1400, 1600, 1800, 2000
                    , 2600, 2800, 700, 800, 1000, 1200, 1400, 1600, 1800, 2000],
                backgroundColor: 'rgba(98, 178, 253, 0.5)',
                borderColor: 'rgba(98, 178, 253, 1)',
                borderWidth: 1
            }]
        };

        const requestData = {
            labels: ["1일", "2일", "3일", "4일", "5일", "6일", "7일", "8일", "9일", "10일"
                , "11일", "12일", "13일", "14일", "15일", "16일", "17일", "18일", "19일", "20일"
                , "21일", "22일", "23일", "24일", "25일", "26일", "27일", "28일", "29일", "30일"],
            datasets: [{
                label: '전월 건수',
                data: [700, 800, 1000, 1200, 1400, 1600, 1800, 2000, 2200, 2400
                    , 2600, 2800, 700, 800, 1000, 1200, 1400, 1600, 1800, 2000
                    , 2600, 2800, 700, 800, 1000, 1200, 1400, 1600, 1800, 2000],
                backgroundColor: 'rgba(98, 178, 253, 0.5)',
                borderColor: 'rgba(98, 178, 253, 1)',
                borderWidth: 1
            }]
        };

        // 차트 생성 함수
        function createCharts() {
            const ctxRevenue = document.getElementById('revenueChart').getContext('2d');
            const ctxOrder = document.getElementById('orderChart').getContext('2d');
            const ctxEstimate = document.getElementById('estimateChart').getContext('2d');
            const ctxRequest = document.getElementById('requestChart').getContext('2d');

            // 기존 차트 인스턴스가 있으면 제거
            if ($('#revenueChart').data('chart')) {
                $('#revenueChart').data('chart').destroy();
            }
            if ($('#orderChart').data('chart')) {
                $('#orderChart').data('chart').destroy();
            }
            if ($('#estimateChart').data('chart')) {
                $('#estimateChart').data('chart').destroy();
            }
            if ($('#requestChart').data('chart')) {
                $('#requestChart').data('chart').destroy();
            }

            // 차트 생성 후 인스턴스를 data 속성에 저장
            $('#revenueChart').data('chart', new Chart(ctxRevenue, {
                type: 'bar',
                data: revenueData,
                options: {
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            }));

            $('#orderChart').data('chart', new Chart(ctxOrder, {
                type: 'bar',
                data: orderData,
                options: {
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            }));

            $('#estimateChart').data('chart', new Chart(ctxEstimate, {
                type: 'bar',
                data: estimateData,
                options: {
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            }));

            $('#requestChart').data('chart', new Chart(ctxRequest, {
                type: 'bar',
                data: requestData,
                options: {
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            }));
        }
        // 모달 열기 함수
        function openModal(chartId) {
            // 아이콘 숨기기
            document.querySelector('.material-symbols-outlined').style.display = 'none';

            let chartInstance = $(`#${chartId}`).data('chart'); // 클릭된 차트의 인스턴스 가져오기
            if (!chartInstance) {
                console.error("차트를 찾을 수 없습니다.");
                return;
            }

            // 모달 열기
            let modal = $('#chartModal');
            modal.show();

            // 모달 캔버스 컨텍스트 가져오기
            let modalChartHolder = $('#modalChartHolder')[0].getContext('2d');
            // 기존 모달 차트가 있으면 삭제 후 생성 (중복 생성 방지)
            if (window.modalChartInstance) {
                window.modalChartInstance.destroy();
            }

            // 약간의 지연 후 차트 생성하여 크기 문제 해결
            setTimeout(() => {
                window.modalChartInstance = new Chart(modalChartHolder, {
                    type: chartInstance.config.type,
                    data: chartInstance.config.data,
                    options: {
                        ...chartInstance.config.options,
                        responsive: true,
                        maintainAspectRatio: false // 모달 크기에 맞추도록 설정
                    }
                });

                // 강제로 리사이즈하여 모달의 크기 맞춤
                window.modalChartInstance.resize();
            }, 3); // 지연 시간 조정
        }
        // 페이지 로드 후 모든 차트 생성 및 이벤트 바인딩
        $(document).ready(function () {
            createCharts(); // 모든 차트를 생성하고 인스턴스 저장

            // 모달 닫기 이벤트
            $(document).on('click', '.close', function () {
                $('#chartModal').hide();
                if (window.modalChartInstance) {
                    window.modalChartInstance.destroy();
                    window.modalChartInstance = null; // 인스턴스 초기화
                }
            });

            // 모달 외부 클릭 시 닫기
            $(window).on('click', function (event) {
                if ($(event.target).is('#chartModal')) {
                    $('#chartModal').hide();
                    if (window.modalChartInstance) {
                        window.modalChartInstance.destroy();
                        window.modalChartInstance = null; // 인스턴스 초기화
                    }
                    document.querySelector('.material-symbols-outlined').style.display = 'inline'; // 아이콘 다시 보이기
                }
            });
        });

        let csrfToken = $("[name=_csrf]").val();

        var swiper = new Swiper(".card-swiper", {
            slidesPerView: 5,
            spaceBetween: 20,
            loop: true,
            speed: 600,
            autoplay: {
                delay: 2500,
                disableOnInteraction: false,
            },
            navigation: {
                nextEl: ".swiper-button-next",
                prevEl: ".swiper-button-prev",
            },
        });

        document.readyState === 'complete' ? init() : window.onload = init;

        // document.getElementById('search_spjangcd')를 기준으로 페이지 reload
        function init() {
            searchCard();
            searcGraph();

        }
        function searchCard(){
            let data2 = [];

            $.ajax({
                url: '/api/dashboard2/',
                type: 'GET',
                data: {
                    'search_spjangcd': $('#search_spjangcd').val()
                },
                async: false,
                success: function (data) {
                    data2 = data.data;
                }
            })
        }

        function searcGraph(){
            let data2 = [];

            $.ajax({
                url: '/api/dashboard2/',
                type: 'GET',
                data: {
                    'search_spjangcd': $('#search_spjangcd').val()
                },
                async: false,
                success: function (data) {
                    data2 = data.data;
                }
            })
        }


    </script>
</th:block>
</html>