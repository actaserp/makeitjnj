<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
<link rel="stylesheet" href="/css/import.css"/>
<link rel="stylesheet" href="/resource/ax5ui/ax5ui.all.css" />
<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 9999; /* z-index를 더 높임 */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
    }

    /* 공통 Modal 컨텐츠 스타일 */
    .modal-content {
        background: white;
        border-radius: 8px;
        margin: 10% auto;
        padding: 20px;
        width: 600px;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        position: relative;
        top: 15%;
    }
</style>
<th:block layout:fragment="content">

    <!--- (레이아웃) Contents 영역 -->
    <div class="layout-contents">
        <!-- Page Title -->
        <div class="page-title-wrap">
            <div class="left">
                <h2>주문 현황</h2><a id="toggleButton" onclick="toggleSearchWrap()"><img src="/images/icon/ico-down.png"
                                                                                     alt="알람 아이콘"></a>
                <!--                <a href="#" title="북마크" class="bookmark toggle">-->
                <!--                    내메뉴-->
                <!--                </a>-->
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
                <li>주문 현황</li>
            </ul>
        </div>
        <!-- Select -->
        <div class="search-wrap" id="searchWrap" style="display: none">
            <ul>
                <li>
                    <select title="지역" id="spworkcd" name="spworkcd"
                            onchange="updateCompcdOptions(); saveSelectedSandanData(); ">
                        <!-- 지역 옵션을 JavaScript에서 동적으로 채움 -->
                    </select>
                    <input type="hidden" id="spworknm" name="spworknm">
                </li>
                <li>
                    <select title="산단" id="spcompcd" name="spcompcd"
                            onchange="updatePlancdOptions(); saveSelectedSandanData();">
                        <!-- 산단 옵션을 JavaScript에서 동적으로 채움 -->
                    </select>
                    <input type="hidden" id="spcompnm" name="spcompnm">
                </li>
                <li>
                    <select title="시설" id="spplancd" name="spplancd"
                            onchange="updatePlannm(); saveSelectedSandanData()">
                        <!-- 시설 옵션을 JavaScript에서 동적으로 채움 -->
                    </select>
                    <input type="hidden" id="spplannm" name="spplannm">
                </li>
            </ul>
        </div>
        <div class="tab-wrap">
            <ul class="tab-links">
                <li>
                    <a href="#tab1" title="주문 캘린더" class="tab-button">주문 캘린더</a>
                </li>
                <li>
                    <a href="#tab2" title="주문현황" class="tab-button">주문현황</a>
                </li>
            </ul>
            <div class="tab-contents">
                <!-- Section -->
                <section class="tab-item" id="tab1" style="height: 900px; margin-bottom: 10px">
                    <div class="row" style="display: flex;">
                        <!-- 왼쪽 섹션: 50% 차지 -->
                        <section
                                style="width: 60%; box-sizing: border-box; height: 830px; margin-right: 20px; border-radius: 10px; ">
                            <div class="title-wrap">
                                <h3>주문 캘린더</h3>
                                <div class="btn-wrap">
                                </div>
                            </div>
                            <div class="calendar-wrap">
                                <div id="calendar"></div>
                            </div>
                        </section>
                        <!-- 오른쪽 섹션을 감싸는 div -->
                        <div style="display: flex; flex-direction: column; width: 40%;">
                            <!-- 위쪽 섹션 -->
                            <section style=" box-sizing: border-box;">
                                <div style="margin-bottom: 15px">
                                    <h3>2024년 주문 현황</h3>
                                </div>
                                <div class="tab-contents">
                                    <div class="row">
                                        <div class="section-card-wrap">
                                            <section style="flex: 0.5; margin-right: 5px;">
                                                <div class="title">
                                                    <h3>주문</h3>
                                                </div>
                                                <div class="data">
                                                    4<span class="small-unit" style=" font-size: 0.5em; opacity: 0.5;"> 건</span>
                                                </div>
                                                <dl>
                                                    <dt>전일대비</dt>
                                                    <dd>
                                                        <span class="down"></span> 1.20 <span class="unit">%</span>
                                                    </dd>
                                                </dl>
                                            </section>
                                            <section style="flex: 0.5; margin-right: 5px;">
                                                <div class="title">
                                                    <h3>진행</h3>
                                                </div>
                                                <div class="data">
                                                    0<span class="small-unit" style=" font-size: 0.5em; opacity: 0.5;"> 건</span>
                                                </div>
                                                <dl>
                                                    <dt>전일대비</dt>
                                                    <dd>
                                                        <span class="up"></span> 1.20 <span class="unit">%</span>
                                                    </dd>
                                                </dl>
                                            </section>
                                            <section style="flex: 0.5; margin-right: 5px;">
                                                <div class="title">
                                                    <h3>출고</h3>
                                                </div>
                                                <div class="data">
                                                    4<span class="small-unit" style=" font-size: 0.5em; opacity: 0.5;"> 건</span>
                                                </div>
                                                <dl>
                                                    <dt>전일대비</dt>
                                                    <dd>
                                                        <span class="down"></span> 1.20 <span class="unit">%</span>
                                                    </dd>
                                                </dl>
                                            </section>
                                        </div> <!--//main-card-wrap end -->
                                    </div>
                                </div>
                            </section>

                            <!-- 아래쪽 섹션 (넓게 설정) -->
                            <section style="flex: 1; box-sizing: border-box; margin-top: 20px;">
                                <div class="tab-item-sub" id="tab1_2">
                                    <div class="section-top" style="margin-top: 10px;">
                                        <div class="search-wrap">
                                            <dl>
                                                <dt>
                                                    조회일자<span class="eq">*</span>
                                                </dt>
                                                <dd>
                                                    <ul class="date-box">
                                                        <li>
                                                            <input type="date" id="startDate2" name="startDate">
                                                            <label for="startDate" class="hide">시작일</label>
                                                        </li>
                                                        <li>
                                                            <input type="date" id="endDate2" name="endDate">
                                                            <label for="endDate" class="hide">종료일</label>
                                                        </li>
                                                        <li>
                                                            <a class="btn btn-delete" title="검색" id="btn-srch">
                                                                <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                                                검색
                                                            </a>
                                                        </li>
                                                    </ul>
                                                </dd>
                                            </dl>
                                        </div>
                                    </div> <!--//section-top end -->
                                    <div class="container-fluid" style="padding-left: 0; padding-right: 0;">
                                        <!-- 그리드 영역 -->
                                        <div class="col-12" style="margin-bottom: 10px;">
                                            <div id="theGrid" style="width: 100%; height: 400px;"></div>
                                        </div>
                                    </div>

                                </div>
                            </section>
                        </div>
                    </div>
                </section>
                <section class="tab-item" id="tab2" style="height: 850px;">
                    <div class="section-top">
                        <div class="search-wrap">
                            <dl>
                                <dt>
                                    주문일자<span class="eq">*</span>
                                </dt>
                                <dd>
                                    <ul class="date-box">
                                        <li>
                                            <input type="date" id="startDate" name="startDate">
                                            <label for="startDate" class="hide">시작일</label>
                                        </li>
                                        <li>
                                            <input type="date" id="endDate" name="endDate">
                                            <label for="endDate" class="hide">종료일</label>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label for="searchCltnm">
                                        업체명<span class="eq">*</span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <input type="text" id="searchCltnm" name="searchCltnm" class="input-srch"
                                               placeholder="업체명" style="border-radius: 5px;">
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label for="searchtketnm">
                                        제목<span class="eq">*</span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <input type="text" id="searchtketnm" name="searchtketnm" class="input-srch"
                                               placeholder="제목" style="border-radius: 5px;">
                                        <!--                                        <a href="#a" class="btn-srch" title="검색" onclick="searchData()"></a>-->
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label for="searchstate">
                                        진행구분<span class="eq">*</span>
                                    </label>
                                </dt>
                             <!--   <dd>
                                    <div class="srch-box">
                                        <select id="searchstate" name="searchstate">
                                            <option value="전체">전체</option>
                                        </select>
                                        &lt;!&ndash;                                        <a href="#a" class="btn-srch" title="검색" onclick="searchData()"></a>&ndash;&gt;
                                    </div>
                                </dd>-->
                                <dd>
                                    <div class="srch-box">
                                        <select id="searchstate" name="searchstate">
                                            <option value="전체">전체</option>
                                            <option value="주문의뢰">주문의뢰</option>
                                            <option value="견적작성">견적작성</option>
                                            <option value="제작">제작</option>
                                            <option value="출고">출고</option>
                                        </select>
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>&nbsp;</dt>
                                <dd>
                                    <li>
                                        <a class="btn btn-delete" title="검색" id="searchButton1" onclick="searchData()">
                                            <!--                                        class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                                            <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                            검색
                                        </a>
                                    </li>
                                </dd>
                            </dl>
                        </div>
                    </div>
                    <div class="container-fluid">
                        <p id="selectedItem"></p>
                        <div id="theGrid2" style="max-height: 800px"></div>
                    </div>
                </section>
            </div>
        </div>
        </section>
    </div> <!--//tab-contens end-->
    </div> <!--//tab-wrap end-->
    </div> <!--//layout-contents end -->
    <footer style="margin-top:5px;">
        <p>Copyrightⓒ 0000 corp. All rights reserved.</p>
    </footer>
    <div style="height: 10px"></div>

    <!-- 모달 HTML 구조 -->
        <div id="CltnmModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="closeCltnmModal()">&times;</span>
                <div id="modalGrid" style="height: 400px; width: 100%;"></div>
            </div>
        </div>

</th:block>
<th:block layout:fragment="scripts">
    <th:block th:replace="/common/columns_setting :: columns_setting"></th:block>
    <script type="text/javascript">

        let theGrid;
        let theGrid2;
        let calendar;
        let modalGrid;

        document.readyState === 'complete' ? init() : window.onload = init;

        // 초반 페이지 진입시 그리드 바인딩 시작
        function init() {
            initCalendar();
            fetchListData2();
            fetchListData();
        }

        $(document).ready(function() {
            // 현재 날짜 가져오기
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth(); // 0부터 시작하는 월(0 = 1월)

            // 시작일: 올해 1월 1일
            const startOfYear = new Date(year, 0, 1);
            const startYearFormatted = startOfYear.getFullYear() + '-' + String(startOfYear.getMonth() + 1).padStart(2, '0') + '-' + String(startOfYear.getDate()).padStart(2, '0');
            $('#startDate').val(startYearFormatted);
            $('#startDate2').val(startYearFormatted);

            // 종료일: 현재 월의 마지막 날
            const endOfMonth = new Date(year, month + 1, 0); // 다음 달 0일은 현재 달의 마지막 날
            const endMonthFormatted = endOfMonth.getFullYear() + '-' + String(endOfMonth.getMonth() + 1).padStart(2, '0') + '-' + String(endOfMonth.getDate()).padStart(2, '0');
            $('#endDate').val(endMonthFormatted);
            $('#endDate2').val(endMonthFormatted);
        });


        function fetchListData() {
            let data2 = []; // 데이터를 담을 배열
            let emptyRowsCount = 8;

            // 빈 객체를 emptyRowsCount만큼 추가
            for (let i = 0; i < emptyRowsCount; i++) {
                data2.push({
                    rownum: i + 1,
                    standdt: '',
                    title: '',
                    smpcost: '',
                    progress: '',
                    amount: ''
                });
            }

            if (!theGrid) {
                theGrid = new wijmo.grid.FlexGrid('#theGrid', {
                    autoGenerateColumns: false,
                    showMarquee: true,
                    columns: [
                        { binding: 'rownum', header: 'No', align: 'center', width: 100 },
                        { binding: 'standdt', header: '의뢰일자', align: 'center', width: 250 },
                        { binding: 'title', header: '제목', align: 'center', width: 250 },
                        { binding: 'smpcost', header: '납품희망일', align: 'center', width: 250 },
                        { binding: 'progress', header: '진행구분', align: 'center', width: 200 },
                        { binding: 'amount', header: '금액', align: 'center', width: 200 }
                    ],
                    itemsSource: data2 // 빈 객체가 추가된 배열 사용
                });

                // 선택이 변경될 때, 현재 항목 업데이트
                theGrid.rowHeaders.columns.splice(0, 1);
                new wijmo.grid.FlexGridContextMenu(theGrid);
                window.downloadFileName = '주문 현황(캘린더)';
            } else {
                // 이미 FlexGrid이 존재하는 경우, 데이터만 업데이트
                theGrid.itemsSource = data2; // 빈 객체가 추가된 배열 사용
            }
        }

        function initCalendar() {
            var calendarEl = document.getElementById('calendar');
            if (calendarEl) {
                // FullCalendar 설정
                calendar = new FullCalendar.Calendar(calendarEl, {
                    locale: 'ko',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    initialView: 'dayGridMonth',
                    height: 714,
                    dayHeaderFormat: { weekday: 'short' },
                    views: {
                        dayGridMonth: {
                            dayCellContent: function (arg) {
                                return arg.dayNumberText.replace('일', '');
                            }
                        }
                    },
                    dateClick: function (info) {
                        console.log('Clicked on: ' + info.dateStr);
                    },
                    events: [] // 기본 이벤트는 빈 배열로 설정
                });

                // 공휴일 데이터 가져오기
                fetchHolidays().then(holidays => {
                    holidays.forEach(holiday => {
                        calendar.addEvent({
                            title: holiday.name, // 공휴일 이름
                            start: holiday.date,  // 공휴일 날짜
                            backgroundColor: '#EC193A',
                            borderColor: '#EC193A',
                            textColor: 'white'
                        });
                    });
                    calendar.render(); // 캘린더 렌더링
                }).catch(error => {
                    console.error('공휴일 데이터를 가져오는 데 실패했습니다:', error);
                });
            }
        }
        // 공휴일 데이터를 가져오는 함수
        async function fetchHolidays() {
            const currentYear = new Date().getFullYear();
            const yearsToFetch = [currentYear - 1, currentYear, currentYear + 1]; // 전년도, 현재 연도, 다음 연도 배열 생성

            const holidays = [];

            for (const year of yearsToFetch) {
                const yearHolidays = await fetchHolidaysForYear(year);
                holidays.push(...yearHolidays);
            }

            return holidays;
        }
        //api 요청
        async function fetchHolidaysForYear(year) {
            return new Promise((resolve, reject) => {
                var xhr = new XMLHttpRequest();
                var url = 'http://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService/getRestDeInfo';
                var queryParams = '?' + encodeURIComponent('serviceKey') + '=' + 'R3P3syhq6qRP0cz8mbV2J5t%2B32WwaSN9sH8ZW4k59oKAU3Ze0WvcljMrN36OJqxs38%2F780hMD4QfhCiDZQNUyA%3D%3D';
                queryParams += '&' + encodeURIComponent('solYear') + '=' + encodeURIComponent(year);
                queryParams += '&' + encodeURIComponent('numOfRows') + '=' + encodeURIComponent('30');

                xhr.open('GET', url + queryParams);
                xhr.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        if (this.status == 200) {
                            var parser = new DOMParser();
                            var xmlDoc = parser.parseFromString(this.responseText, "text/xml");

                            // XML에서 원하는 데이터 추출
                            var items = xmlDoc.getElementsByTagName("item");
                            let holidays = [];
                            for (var i = 0; i < items.length; i++) {
                                var locdate = items[i].getElementsByTagName("locdate")[0].textContent;
                                var dateName = items[i].getElementsByTagName("dateName")[0].textContent;

                                holidays.push({ date: locdate, name: dateName });
                            }
                            resolve(holidays);
                        } else {
                            console.error('오류 발생. HTTP 상태 코드:', this.status);
                            reject(this.status);
                        }
                    }
                };

                xhr.send();
            });
        }

        function fetchListData2() {
            let data2 = []; // 데이터를 담을 기본 배열 초기화

            // 서버에서 데이터 가져오기
            $.ajax({
                url: '/api/order_status/read',
                type: 'GET',
                async: false,
                success: function (response) {
                    // 응답이 올바르게 도착했고, data 속성이 배열인지 확인
                    if (response && Array.isArray(response.data)) {
                        data2 = response.data;
                        // 날짜 형식 변환
                        data2.forEach(item => {
                            item.reqdate = formatDateString(item.reqdate);
                            item.deldate = formatDateString(item.deldate);
                        });
                    }
                },
                error: function () {
                    console.error("데이터를 가져오는 중 오류가 발생했습니다.");
                }
            });

            // 순번을 추가하고, 데이터가 10개 미만일 경우 빈 행을 추가
            const minimumRows = 12;
            data2.forEach((item, index) => {
                item.rownum = index + 1; // 순번 추가
            });

            if (data2.length < minimumRows) {
                const additionalRows = minimumRows - data2.length;
                for (let i = 0; i < additionalRows; i++) {
                    data2.push({
                        rownum: data2.length + 1, // 현재 데이터 길이에 맞게 순번을 맞춤
                        ordflag: '',
                        reqdate: '',
                        cltnm: '',
                        remark: '',
                        deldate: '',
                        hgrb: '',
                        qty: '',
                        panel_t: '',
                        panel_w: '',
                        panel_l: '',
                        exfmtypedv: '',
                        infmtypedv: '',
                        stframedv: '',
                        stexplydv: '',
                        remark: ''
                    });
                }
            }

            // CollectionView 생성 및 FlexGrid 바인딩
            let viewdata = new wijmo.collections.CollectionView(data2);

            if (!theGrid2) {
                // theGrid2가 처음 생성되는 경우 설정
                theGrid2 = new wijmo.grid.FlexGrid('#theGrid2', {
                    autoGenerateColumns: false,
                    showMarquee: true,
                    columns: [
                        {binding: 'rownum', header: '순번', width: 70, align: 'center'},
                        {binding: 'ordflag', header: '진행구분', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'reqdate', header: '주문일자', width: '*', minWidth: 150, align: 'center'},
                        {binding: 'cltnm', header: '업체명', width: '*', minWidth: 150, align: 'left'},
                        {binding: 'remark', header: '제목', width: '*', minWidth: 200, align: 'left'},
                        {binding: 'deldate', header: '납품희망일', width: '*', minWidth: 150, align: 'center'},
                        {binding: 'hgrb', header: '제품구성', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'qty', header: '수량', width: 80, align: 'right'},
                        {binding: 'panel_t', header: 'T(두께)', width: 80, align: 'right'},
                        {binding: 'panel_w', header: 'W/H(폭 또는 높이)', width: 150, align: 'right'},
                        {binding: 'panel_l', header: 'L(길이)', width: 80, align: 'right'},
                        {binding: 'exfmtypedv', header: '외부마감재', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'infmtypedv', header: '외부보강재', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'stframedv', header: '내부보강재', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'stexplydv', header: '내부마감재', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'remark', header: '옵션 및 요청사항', width: '*', minWidth: 200, align: 'left'}
                    ],
                    itemsSource: viewdata // 서버에서 가져온 데이터를 바인딩
                });

                // 선택이 변경될 때, 현재 항목 업데이트
                theGrid2.rowHeaders.columns.splice(0, 1); // 맨 앞에 헤더 부분 없애기
                new FlexGridContextMenu(theGrid2);
                window.downloadFileName = '진행 현황';

            } else {
                // 이미 FlexGrid가 존재하는 경우, 데이터만 업데이트
                theGrid2.itemsSource = viewdata;
            }
        }
        function formatDateString(dateString) {
            if (!dateString || dateString.length !== 8) return dateString; // 유효성 검사
            const year = dateString.substring(0, 4);
            const month = dateString.substring(4, 6);
            const day = dateString.substring(6, 8);
            return `${year}-${month}-${day}`;
        }

        function searchData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const searchCltnm = document.getElementById('searchCltnm').value.trim();
            const searchtketnm = document.getElementById('searchtketnm').value.trim();
            const searchstate = document.getElementById('searchstate').value;

            const queryParams = {};
            if (startDate) queryParams.startDate = startDate;
            if (endDate) queryParams.endDate = endDate;
            if (searchCltnm) queryParams.searchCltnm = searchCltnm;
            if (searchtketnm) queryParams.searchtketnm = searchtketnm;
            if (searchstate) queryParams.searchstate = searchstate;

            // AJAX 요청
            $.ajax({
                url: `/api/order_status/searchData?${$.param(queryParams)}`,
                type: 'GET',
                success: function (response) {
                    console.log("서버 응답 데이터:", response); // 응답 데이터 확인

                    // 응답 데이터가 올바른지 확인
                    if (response && Array.isArray(response.data)) {
                        const data2 = response.data;

                        // 날짜 형식 변환
                        data2.forEach(item => {
                            item.reqdate = formatDateString(item.reqdate);
                            item.deldate = formatDateString(item.deldate);
                        });

                        // 순번을 추가하고, 데이터가 10개 미만일 경우 빈 행을 추가
                        const minimumRows = 12;
                        data2.forEach((item, index) => {
                            item.rownum = index + 1; // 순번 추가
                        });

                        if (data2.length < minimumRows) {
                            const additionalRows = minimumRows - data2.length;
                            for (let i = 0; i < additionalRows; i++) {
                                data2.push({
                                    rownum: data2.length + 1, // 현재 데이터 길이에 맞게 순번을 맞춤
                                    ordflag: '',
                                    reqdate: '',
                                    cltnm: '',
                                    remark: '',
                                    deldate: '',
                                    hgrb: '',
                                    qty: '',
                                    panel_t: '',
                                    panel_w: '',
                                    panel_l: '',
                                    exfmtypedv: '',
                                    infmtypedv: '',
                                    stframedv: '',
                                    stexplydv: '',
                                    remark: ''
                                });
                            }
                        }
                        
                        // 그리드 업데이트
                        const viewdata = new wijmo.collections.CollectionView(data2);
                        if (!theGrid2) {
                            theGrid2 = new wijmo.grid.FlexGrid('#theGrid2', {
                                autoGenerateColumns: false,
                                showMarquee: true,
                                columns: [
                                    {binding: 'rownum', header: '순번', width: 70, align: 'center'},
                                    {binding: 'ordflag', header: '진행구분', width: '*', minWidth: 100, align: 'center'},
                                    {binding: 'reqdate', header: '주문일자', width: '*', minWidth: 150, align: 'center'},
                                    {binding: 'cltnm', header: '업체명', width: '*', minWidth: 150, align: 'left'},
                                    {binding: 'remark', header: '제목', width: '*', minWidth: 200, align: 'left'},
                                    {binding: 'deldate', header: '납품희망일', width: '*', minWidth: 150, align: 'center'},
                                    {binding: 'hgrb', header: '제품구성', width: '*', minWidth: 100, align: 'center'},
                                    {binding: 'qty', header: '수량', width: 80, align: 'right'},
                                    {binding: 'panel_t', header: 'T(두께)', width: 80, align: 'right'},
                                    {binding: 'panel_w', header: 'W/H(폭 또는 높이)', width: 150, align: 'right'},
                                    {binding: 'panel_l', header: 'L(길이)', width: 80, align: 'right'},
                                    {binding: 'exfmtypedv', header: '외부마감재', width: '*', minWidth: 100, align: 'center'},
                                    {binding: 'infmtypedv', header: '외부보강재', width: '*', minWidth: 100, align: 'center'},
                                    {binding: 'stframedv', header: '내부보강재', width: '*', minWidth: 100, align: 'center'},
                                    {binding: 'stexplydv', header: '내부마감재', width: '*', minWidth: 100, align: 'center'},
                                    {binding: 'remark', header: '옵션 및 요청사항', width: '*', minWidth: 200, align: 'left'}
                                ],
                                itemsSource: viewdata // 데이터 바인딩
                            });
                            new FlexGridContextMenu(theGrid2);
                            window.downloadFileName = '진행 현황';

                        } else {
                            theGrid2.itemsSource = viewdata;
                        }
                    } else {
                        console.error("데이터 형식이 잘못되었습니다. response.data가 배열이 아닙니다.");
                    }
                },
                error: function () {
                    console.error("데이터를 가져오는 중 오류가 발생했습니다.");
                }
            });
        }//검색

        /*모달창*/
        document.addEventListener("DOMContentLoaded", function() {
            let modalGrid = null; // FlexGrid 인스턴스 초기화

            // Enter 키를 눌렀을 때 실행할 함수 정의
            function handleEnterKey() {
                const inputValue = document.getElementById("searchCltnm").value;
                console.log("입력된 업체명:", inputValue);
                openModal(); // 모달 열기
            }

            function createModalGrid() {
                const Modaldata = []; // 서버로부터 받은 데이터를 저장할 배열
                const minimumRows = 10; // 최소 행 개수 설정

                // 서버에서 데이터 가져오기
                $.ajax({
                    url: '/api/order_status/ModalRead',
                    type: 'GET',
                    async: true,
                    success: function(response) {
                        if (response && Array.isArray(response.data)) {
                            Modaldata.push(...response.data); // 데이터가 있을 경우 추가
                        }

                        // 최소 행 개수보다 데이터가 적을 경우 빈 행을 추가
                        if (Modaldata.length < minimumRows) {
                            const additionalRows = minimumRows - Modaldata.length;
                            for (let i = 0; i < additionalRows; i++) {
                                Modaldata.push({
                                    cltcd: '',
                                    cltnm: '',
                                    telnum: '',
                                    cltadres: ''
                                });
                            }
                        }

                        // CollectionView 생성
                        const viewdata = new wijmo.collections.CollectionView(Modaldata);

                        // FlexGrid 초기화 또는 업데이트
                        if (!modalGrid) {
                            // FlexGrid를 처음 생성하는 경우
                            modalGrid = new wijmo.grid.FlexGrid('#modalGrid', {
                                autoGenerateColumns: false,
                                columns: [
                                    { binding: 'cltcd', header: '코드', width: '*', minWidth: 100, align: 'center' },
                                    { binding: 'cltnm', header: '거래처명', width: '*' },
                                    { binding: 'telnum', header: '전화', width: '*' },
                                    { binding: 'cltadres', header: '주소', width: '*' }
                                ],
                                itemsSource: viewdata // CollectionView를 데이터 소스로 설정
                            });
                        } else {
                            // 이미 FlexGrid가 존재하는 경우, 데이터만 업데이트
                            modalGrid.itemsSource = viewdata;
                        }
                    },
                    error: function() {
                        console.error("데이터를 가져오는 중 오류가 발생했습니다.");
                    }
                });
            }

            function openModal() {
                // 모달 요소를 가져옵니다.
                const modalElement = document.getElementById('CltnmModal');
                const wrapper = document.getElementById('wrapper1');

                if (modalElement) {
                    modalElement.style.display = 'block';  // 모달을 화면에 표시합니다.
                    console.log("모달이 열립니다"); // 콘솔에서 확인용
                    if (wrapper) {
                        wrapper.style.display = 'block';
                    }

                    createModalGrid(); // 그리드 생성
                } else {
                    console.error("모달 요소를 찾을 수 없습니다.");
                }
            }


            // 모달 닫기 함수
            function closeCltnmModal() {
                const modalElement = document.getElementById('CltnmModal');
                if (modalElement) {
                    modalElement.style.display = 'none';
                }
            }

            // 모달 외부 클릭 시 닫기
            window.onclick = function(event) {
                const modalElement = document.getElementById('CltnmModal');
                if (event.target === modalElement) {
                    closeCltnmModal();
                }
            };

            // Enter 키 입력 감지 및 모달 열기 이벤트 추가
            const searchCltnmInput = document.getElementById("searchCltnm");
            if (searchCltnmInput) {
                searchCltnmInput.addEventListener("keydown", function(event) {
                    if (event.key === "Enter") {
                        event.preventDefault(); // 기본 폼 제출 방지
                        handleEnterKey();       // 함수 호출
                    }
                });
            } else {
                console.error("ID가 'searchCltnm'인 요소를 찾을 수 없습니다.");
            }
        });
        function resetForm() {
            // 검색 관련 필드 초기화 (일반 텍스트 입력 필드)
            const searchInputIds = [
                'searchCltnm', 'searchtketnm'
            ];

            searchInputIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = ''; // 텍스트 필드를 빈 문자열로 초기화
                }
            });

            // 드롭다운 필드 초기화
            const dropdown = document.getElementById('searchstate');
            if (dropdown) {
                dropdown.value = '전체'; // 드롭다운을 기본값('전체')으로 설정
            }
        }
    </script>
</th:block>
</html>

